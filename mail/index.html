<!DOCTYPE html>
<html lang="ja">

<head>
    <title>hitokuchi Mail</title>
    <meta charset="utf-8">
    <meta property="og:title" content="hitokuchi mail">
    <meta property="og:description" content="hitokuchi mailでは登録しあっている人同士で簡易的なメールのやり取りが出来ます！">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./pagestyle.css">
    <link rel="shortcut icon" href="../hitokuchi_logo.webp" type="image/webp">
</head>

<body>
    <div class="box">
        <h2>hitokuchi mail</h2>
        <a href="signup.html" class="link_color">サインアップ</a> | <a href="../ja-JP/index.html"
            class="link_color">hitokuchiへ戻る</a><br>
        <p></p>
        <small>サービスを使うことにより<a href="../tos/index.html">利用規約</a>に同意したとみなされます</small>
        <p></p>
    </div>
    <br>
    <div class="box">
        <h3 id="title">ログイン</h3>
        <div id="login_box">
            <br>
            <form>
                ユーザー名: <input type="text" name="username" id="user_id"> @hitokuchi.mail<br>
                合言葉: <input type="password" name="password" id="user_pass"><br>
                <input type="hidden" id="req" value="login">

                <div class="mail_buttons">
                    <input type="button" class="mail_button" value="ログイン" onclick="login()">
                    <input type="reset" class="mail_button" value="取り消し">
                </div>
                <p></p>
            </form>
        </div>
        <small id="status"></small>

        <br>
    </div>
    <br>
    <div class="box">
        <h3>テキスト編集</h3>
        <p>
            <span class="hutoji">リンク</span>: $(URL)[表示するテキスト]<br>
            <span class="hutoji">取り消し線</span>: [d テキスト]<br>
            <span class="hutoji">斜体</span>: [i テキスト]<br>
            <span class="hutoji">太字</span>: [b テキスト]<br>
            <span class="hutoji">日付</span>: :DATE:
        </p>
        <hr>
        <h3>連絡先</h3>
        <p>
            僕のユーザー名: admin<br>
            テストがてらぜひ送ってみてください
        </p>
    </div>


    <script src="./config.js"></script>
    <script>
        const url = key.url;

        async function get_messages(user_id, user_pass) { // メッセージを受信
            const status = document.getElementById("status");
            status.innerHTML = "受信中...";
            const message_response = await fetch(
                url,
                {
                    method: "POST",
                    body: JSON.stringify({
                        "address": user_id,
                        "password": user_pass,
                        "request": "get"
                    })
                }
            ).then((response) => response.text())
                .then((data) => JSON.parse(data))
                .catch((error) => "posterror");

            if (message_response.result == "wrong_password" || message_response.request == "wrong_account" || message_response == "posterror") {
                status.innerHTML = "エラー";
            } else {
                let mesbox = document.getElementById("login_box");

                let mem = `<table>
                                            <thead>
                                                <tr><th class="from">From</th><th class="message_top" colspan="2">Message</th></tr>
                                            </thead>
                                            <tbody>`;
                for (const i of message_response.result) {
                    mem += `<tr>
                                        <td class="from">${i.from}</td>
                                        <td class="message">${i.mes}</td>
                                        <td class="menu"><button onclick="delete_message('${i.uuid}')" id="${i.uuid}" class="delete-button">×</button></td>
                                    </tr>`;
                }

                mem += `</tbody>
                                </table>
                                <button onclick="get_messages('${user_id}', '${user_pass}')" class="reload-button">　　再読込み　　</button>
                                <br>
                                <h3>メール作成</h3>
                                <form>
                                    宛先: <input type="text" name="username" id="to"> @hitokuchi.mail<br>
                                    差出人: <input type="text" name="username" id="from" value="${user_id}" readonly> @hitokuchi.mail<br>
                                    本文<br><textarea id="message"></textarea><br>
                                    <div class="mail_buttons">
                                    <input type="hidden" id="req2" value="send">
                                    <input type="button" value="送信" class="mail_button" onclick="send()">　<input type="reset" class="mail_button" value="取り消し"> 
                                    </div> 
                                </form>`;



                mesbox.innerHTML = mem;
                status.innerHTML = "";
            }
        }

        async function login() { // ログイン
            const status = document.getElementById("status");
            status.innerHTML = "お待ちください...";
            status.style.color = "red";

            const user_id = document.getElementById("user_id").value;
            const user_pass = document.getElementById("user_pass").value;

            if (user_id.trim() != "" && user_pass.trim() != "") { // もし空の場合
                const response = await fetch(
                    url,
                    {
                        method: "POST",
                        body: JSON.stringify({
                            "address": user_id,
                            "password": user_pass,
                            "request": document.getElementById("req").value
                        })
                    }
                )
                    .then((response) => response.text())

                    .then((data) => {
                        return JSON.parse(data);
                    })

                    .catch((error) => {
                        return "posterror";
                    });

                if (response.result.match("wrong")) {
                    status.innerHTML = "エラー: あいことばまたはIDが違います";
                } else if (response.result.match("ok")) {
                    console.log("ok");
                    status.innerHTML = "";
                    document.getElementById("login_box").innerHTML = "";
                    document.getElementById("title").innerHTML = "メッセージ";

                    get_messages(user_id, user_pass);
                    status.innerHTML = "";
                }
            } else {
                status.innerHTML = "エラー: あいことばもIDも入力してください";
            }

        }

        async function send() {
            const status = document.getElementById("status");

            status.innerHTML = "お待ちください...";
            status.style.color = "red";

            const user_id = document.getElementById("to").value;
            const from_id = document.getElementById("from").value;

            let message = document.getElementById("message").value;
            message = message.split("&").join("&amp;"); // 下の&と一緒にreplaceされてしまうので修正
            message = message.split("<").join("&lt;"); // &lt;&gt;
            message = message.split(">").join("&gt;");
            message = message.split("\n").join("<br>");

            message = message.replace(/\$\((.+?)\)\[(.+?)\]/g, "<a href='$1' target='_blank'>$2</a>");
            message = message.replace(/\[b (.+?)\]/g, "<span class='hutoji'>$1</span>");
            message = message.replace(/\[i (.+?)\]/g, "<span class='shatai'>$1</span>");
            message = message.replace(/\[d (.+?)\]/g, "<span class='torikeshi'>$1</span>");

            const today = new Date();
            const today_text = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
            message = message.replace(/:DATE:/g, `<span>${today_text}</span>`);

            if (from_id.trim() != "" && message.trim() != "" && user_id.trim() != "") {
                const response = await fetch(
                    url,
                    {
                        method: "POST",
                        body: JSON.stringify({
                            "to": user_id,
                            "from": from_id,
                            "message": message,
                            "request": document.getElementById("req2").value
                        })
                    }
                )
                    .then((response) => response.text())

                    .then((data) => {
                        return JSON.parse(data);
                    })

                    .catch((error) => {
                        return "posterror";
                    });

                if (response.result.match("wrong_to")) {
                    status.innerHTML = "エラー: 宛先が誤っています";
                } else if (response.result.match("ok")) {
                    document.getElementById("to").value = "";
                    document.getElementById("message").value = "";

                    sendip(from_id + " to " + user_id, message, "mail");
                    status.innerHTML = "送信済み";
                }
            } else {
                status.innerHTML = "エラー: 宛先またはメッセージ等を入力してください";
            }

        }

        async function delete_message(uuid) {
            const status = document.getElementById("status");
            status.innerHTML = "お待ちください...";
            status.style.color = "red";

            const del_response = await fetch(
                url,
                {
                    method: "POST",
                    body: JSON.stringify({
                        "uuid": uuid,
                        "request": "delete"
                    })
                }
            )
                .then((response) => response.text())

                .then((data) => {
                    return JSON.parse(data);
                })

                .catch((error) => {
                    console.error(error);
                    return "posterror";
                });

            if (del_response.result == "wrong_uuid" || del_response == "posterror") {
                status.innerHTML = "エラー: UUIDの値が不正または通信エラー";
            } else {
                document.getElementById(uuid).innerHTML = "削除済み";
                document.getElementById(uuid).disabled = "disabled";

                status.innerHTML = "";
            }
        }

        document.getElementsByTagName('html')[0].oncontextmenu = () => {
            return false;
        }
    </script>

</body>

</html>